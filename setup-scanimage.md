## This is a copy of a set of emails figuring out how to configure ScanImage to **not** save negative values in Tiff images.

215 How to handle negative intensity values saved in ScanImage Tiff files?
Reported by robert cudmore
Created on Thu, 16 May at 11:35 PM
Hi again,

Can you help me with how to convert the intensity values of SI4 and/or SI5 Tiff files such that they do not include negative numbers? Is there a magic value I can add or subtract to make all intensity values start at 0? If so, does this magic number work across different scopes? Or is there some user configuration that might change it? I need this because (i) my image analysis pipeline assumes pixel intensity values in a digital image are unsigned integers and (ii) I need to compare absolute intensity values across multiple time-points.

When I open SI4/5 saved Tiff files in Fiji they have negative intensity values. I can read the 'calibration' and see there is a linear offset, something like 'y=-32768.0+(1.0)*x'. The problem is, the Tiff file image has an actual minimum intensity of '31473.0' (for example). Thus, when I subtract out the linear calibration I get 31473-32768=-1295 and we are still at the original problem of negative intensity values?

For SI4 files off of one particular scope (in the Huganir lab at Hopkins), we came up with a magic number 2^15-128=32640 that seemed to work. But with newer files saved in SI5 and on a different scope, this magic number no longer works as it is too big. For example, a newer SI5 file has a minimum intensity value of 31473.0 giving us 31473.0-32640=-1167

I have attached an example SI5 Tiff file with a minimum intensity value of 31473 and a max of 38953. How would I convert this image such that the first intensity value is at 0? Do I just subtract the minimum? OR is there some magic number to subtract?

I really want to understand this because my users are doing intensity analysis of the same brain region across multiple time-points. I don't want my conversion (with my magic number or the minimum in each image) to be shifting the actual intensity in some artificial way.

To conclude, this conversion is being done with Fiji Jython scripts using Bio-Formats to generate unsigned integer Tiff files that is then imported into the increasingly popular image analysis software called MapManager (http://mapmanager.net).

Thanks in advance,

Robert Cudmore
___________________________________________
Assistant Professor, Department of Physiology and Membrane Biology
The University of California at Davis - School of Medicine
robertcudmore.org
1 Attachments
TIF
20190514fast...
( 4.01 MB )
Add note

Conversation
Jacob Franklin on Fri, 17 May at 10:10 AM
Hi Robert Cudmore,

I am not sure I follow exactly. For one the min and max of that image appear to be -1295 and 4041 respectively. Are you reading the min and max from imageJ?

Thanks,
Jacob
​

Ticket: https://vidriotech.freshdesk.com/public/tickets/06d7d8496267477b5064740bace50d5e93090a058c763b0303b0739113a31f53

Georg JaindlGeorg Jaindl on Fri, 17 May at 10:28 AM
Hi Robert,

Ticket: https://vidriotech.freshdesk.com/public/tickets/06d7d8496267477b5064740bace50d5e93090a058c763b0303b0739113a31f53

The ScanImage systems reads out the voltage generated by the PMT transimpedance amplifier. This is by nature an analog signal and it can take on any value (positive or negative) relative to ground. ScanImage simply reads in this data, averages a few samples per pixel and writes that data into the Tiff file in  a signed int16 format. The negative values simply represent the voltage generated by the transimpedance amplifier.

The scaling that you see in ImageJ (y=-32768.0+(1.0)*x ) just says that the image data is a signed integer int16.
The true data range of the first frame in the Tiff file is [-1295 4041]. The input range of the NI Digitizer you are using is [-1 1]Volts, at an input resolution of 14bit. This means that a pixel value of -8192 is -1V, a pixel value of 8191 is +1V.

There is one complication: ScanImage does allow to set a pixel value offset (see channels window). The offset value is added to the pixel value. This allows to compensate for dark current. The offset value is measured before every acquisition if the Auto Read checkbox is checked (you will see the values change when you click focus). If you want to compare intensity values from session to session, you should deactivate auto read and fix the offset value. If you want to guarantee that there are no negative values, you can set the offset to 8192. This will bring your pixel range to [0 16384].

Hope this helps.
Cheers,
Georg


Jacob Franklin on Fri, 17 May at 10:36 AM
Hi Robert Cudmore,
​
In addition to what Georg said, negative pixel values can typically be thresholded out as they should be much lower than photon responses, and if you had a tiff where minimum values where greater than 0 and you wanted to have this on a range that started with 0 I would recommend doing some sort of interpolated map between ranges. 
​
Thanks,
Jacob

Ticket: https://vidriotech.freshdesk.com/public/tickets/06d7d8496267477b5064740bace50d5e93090a058c763b0303b0739113a31f53

robert cudmore on Fri, 17 May at 1:07 PM
Hi Georg and Jacob,

Thanks for the detailed explanation, very helpful. I want to decide on a simple workflow to tell my users to use for comparing intensity values between sessions. Based on your feedback, how does this sound:

Option 1)
   1.1) Users must turn off the 'auto read' checkbox in the 'channels window'. They will still have some undefined offset but it will stay the same.
   1.2) In my Fiji scripts that convert ScanImage Tiff to a Tiff I will use in my analysis, I will set all negative values to 0.

Options 2)
   2.1) Users must turn off 'auto read' checkbox and set the offset to 8192.
   2.2) In my Fiji scripts that convert ScanImage Tiff to a Tiff I will use in my analysis, there will never be negative values thus no special action is needed.

I think what I will do is (i) make sure users turn off 'auto read', (ii) always check for negative values and set them to 0. This way I don't care if they took the extra step of setting offset to 8192. As long as they turn off 'auto read' it should work out, assuming any negative values I get will not be part of the signal (e.g. photons from a fluorophore).


Thanks,

Robert
___________________________________________
Assistant Professor, Department of Physiology and Membrane Biology
The University of California at Davis - School of Medicine
robertcudmore.org
